"use strict";(self.webpackChunkoverture_documentation=self.webpackChunkoverture_documentation||[]).push([[7905],{92921:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>c,frontMatter:()=>i,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"examples/spark","title":"Overture with Spark","description":"extract and manipulate Overture data with Spark.","source":"@site/docs/examples/spark.mdx","sourceDirName":"examples","slug":"/examples/spark","permalink":"/examples/spark","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":1746825067000,"frontMatter":{"description":"extract and manipulate Overture data with Spark.","title":"Overture with Spark"},"sidebar":"docs","previous":{"title":"Examples","permalink":"/examples/"},"next":{"title":"Overture + Pandas","permalink":"/examples/pandas"}}');var s=a(74848),n=a(28453);a(65537),a(79329);const i={description:"extract and manipulate Overture data with Spark.",title:"Overture with Spark"},l=void 0,o={},d=[{value:"Why Spark?",id:"why-spark",level:2},{value:"Why Spark with Overture?",id:"why-spark-with-overture",level:2},{value:"Example",id:"example",level:2},{value:"Next steps",id:"next-steps",level:2}];function p(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,n.R)(),...e.components},{Details:a}=t;return a||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(t.p,{children:["In this example, we'll show you how to use ",(0,s.jsx)(t.a,{href:"https://spark.apache.org/",children:"Spark"})," in Python to extract and manipulate Overture data in a Jupyter notebook."]}),"\n",(0,s.jsx)(t.h2,{id:"why-spark",children:"Why Spark?"}),"\n",(0,s.jsx)(t.p,{children:"Spark is a robust distributed compute engine designed for scalable, fault-tolerant data processing across clusters. It provides a powerful mix of in-memory computation, lazy evaluation, and a declarative programming model, allowing users to build complex data pipelines that are automatically optimized for performance. Spark integrates seamlessly with common storage systems like S3 and supports multiple languages including Python, Java, Scala, and R, as well as SQL."}),"\n",(0,s.jsx)(t.h2,{id:"why-spark-with-overture",children:"Why Spark with Overture?"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Scales to big data"}),": Overture queries can contain millions of records, and Spark\u2019s distributed architecture scales compute and memory to process them efficiently."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Leverages declarative programming paradigms and lazy evaluation"}),": Spark builds execution plans and defers running operations until actions like ",(0,s.jsx)(t.code,{children:"display()"}),", ",(0,s.jsx)(t.code,{children:"print()"}),", ",(0,s.jsx)(t.code,{children:"count()"}),", or ",(0,s.jsx)(t.code,{children:".write"})," collect data to memory. This enables complex transformations on Overture data to be optimized without overwhelming your system's memory."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Enables efficient predicate pushdown with parquet"}),": Spark intelligently applies filters at the file scan level using Parquet metadata, so even complex filters on Overture data only read the necessary rows. Given Overture is stored in ",(0,s.jsx)(t.a,{href:"https://geoparquet.org/",children:"GeoParquet"}),", Spark is a great fit."]}),"\n",(0,s.jsxs)(t.li,{children:[(0,s.jsx)(t.strong,{children:"Integrates easily with S3"}),": Spark treats S3 paths like local filesystem paths, making it simple to load Overture datasets directly without manual file handling or custom connectors."]}),"\n"]}),"\n",(0,s.jsxs)(a,{children:[(0,s.jsx)("summary",{children:(0,s.jsx)(t.p,{children:(0,s.jsx)(t.strong,{children:"Installation requirements"})})}),(0,s.jsxs)(t.p,{children:["To follow along with these examples, you should have ",(0,s.jsx)(t.a,{href:"https://jupyter.org/",children:"JupyterLab or Jupyter Notebook"})," running and the following dependencies installed:"]}),(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"https://spark.apache.org/docs/latest/api/python/getting_started/install.html",children:"PySpark"})}),"\n"]})]}),"\n",(0,s.jsx)(t.h2,{id:"example",children:"Example"}),"\n",(0,s.jsx)(t.p,{children:"First, let's install pyspark."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"pip install pyspark\n"})}),"\n",(0,s.jsx)(t.p,{children:"With our newest dependency installed, let's start by defining our configuration."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'import pyspark.sql.functions as F\nfrom pyspark.sql import SparkSession\n\n# Define our spark session\n# For more, visit the spark docs: https://spark.apache.org/docs/latest/sql-getting-started.html\nspark = SparkSession.builder.getOrCreate()\n\n# Define constants for our read\nOVERTURE_RELEASE = "2025-01-22.0"\nCOUNTRY_CODES_OF_INTEREST = ["US", "GH"]\nSOURCE_DATA_URL = f"s3a://overturemaps-us-west-2/release/{OVERTURE_RELEASE}/theme=places/type=place"\nOUTPUT_FILE = "my_super_cool_data.parquet"\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Next, let's define a simple lazily-evaluated filter. Note that this filter on ",(0,s.jsx)(t.code,{children:"COUNTRY_CODES_OF_INTEREST"})," will be pushed down to parquet. If there is relevant metadata in the parquet file, spark will be able to skip entire row groups and sometimes even entire parquet files when scanning for the criteria in the filter."]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'country_overlap_condition = F.arrays_overlap(\n    F.col("addresses.country"),\n    F.array(*[F.lit(x.upper()) for x in COUNTRY_CODES_OF_INTEREST]),\n)\n'})}),"\n",(0,s.jsx)(t.p,{children:"With our filter defined, let's define our read and some additional metadata columns."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'source_df = (\n    spark.read.format("parquet")\n    .load(SOURCE_DATA_URL)\n    .filter(country_overlap_condition)\n    .withColumn("_overture_release_version", F.lit(OVERTURE_RELEASE))\n    .withColumn("_ingest_timestamp", F.current_timestamp())\n)\n'})}),"\n",(0,s.jsxs)(t.p,{children:["With eagerly evaluated frameworks, such as ",(0,s.jsx)(t.a,{href:"https://pandas.pydata.org/",children:"Pandas"}),", the above step would immediately load data into memory. However, Spark is lazily evaluated, so transformations are planned but not executed until an action like ",(0,s.jsx)(t.code,{children:".write()"})," or ",(0,s.jsx)(t.code,{children:".show()"})," triggers a distributed computation."]}),"\n",(0,s.jsx)(t.p,{children:"To actually run a transformation, let's write this new dataset to another Parquet file on our local system."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'source_df.write.mode("append").format("parquet").save(OUTPUT_FILE)\n'})}),"\n",(0,s.jsx)(t.p,{children:"And that's it! You've successfully used Spark to extract and transform Overture data."}),"\n",(0,s.jsx)(t.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["To run scalable ML algorithms on Spark, explore ",(0,s.jsx)(t.a,{href:"https://spark.apache.org/docs/latest/ml-guide.html",children:"Spark MLib"}),", which offers a range of distributed machine learning models and tools."]}),"\n",(0,s.jsxs)(t.li,{children:["For efficient execution of arbitrary columnar operations in Python, start with a ",(0,s.jsx)(t.a,{href:"https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.functions.pandas_udf.html",children:"Pandas UDF"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["For broader parallelism beyond Spark\u2019s native model, consider ",(0,s.jsx)(t.a,{href:"https://docs.ray.io/en/latest/ray-more-libs/raydp.html",children:"Ray on Spark"})," or standalone Ray to orchestrate distributed execution of arbitrary Python code."]}),"\n"]})]})}function c(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}}}]);