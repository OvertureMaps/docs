"use strict";(self.webpackChunkoverture_documentation=self.webpackChunkoverture_documentation||[]).push([[4161],{75085:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>i,contentTitle:()=>o,default:()=>c,frontMatter:()=>s,metadata:()=>l,toc:()=>u});var n=a(74848),r=a(28453);a(11470),a(19365);const s={description:"extract and manipulate Overture data with DuckDB and Pandas",title:"Overture + Pandas"},o=void 0,l={id:"examples/pandas",title:"Overture + Pandas",description:"extract and manipulate Overture data with DuckDB and Pandas",source:"@site/docs/examples/pandas.mdx",sourceDirName:"examples",slug:"/examples/pandas",permalink:"/examples/pandas",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedAt:1726064411e3,frontMatter:{description:"extract and manipulate Overture data with DuckDB and Pandas",title:"Overture + Pandas"},sidebar:"docs",previous:{title:"Examples",permalink:"/examples/"},next:{title:"Overture + Lonboard",permalink:"/examples/lonboard"}},i={},u=[{value:"Example",id:"example",level:2},{value:"Next steps",id:"next-steps",level:2}];function d(e){const t={a:"a",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{Details:s}=t;return s||function(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(t.p,{children:["In this example, we'll show you how to use ",(0,n.jsx)(t.a,{href:"https://duckdb.org/",children:"DuckDB"})," and ",(0,n.jsx)(t.a,{href:"http://pandas.pydata.org/",children:"Pandas"}),' to extract and manipulate Overture data in a Jupyter notebook. We\'re using a Pandas DataFrame as an ideal structure for handling a "medium" amount of data and ',(0,n.jsx)(t.a,{href:"https://geopandas.org/en/stable/index.html",children:"GeoPandas"})," to extend Pandas for operations on geometric types. We also need the ",(0,n.jsx)(t.a,{href:"https://shapely.readthedocs.io/en/stable/index.html",children:"Shapely"})," to support the processing of our feature geometries. DuckDB allows us to fetch only the data we need from Overture's GeoParquet files stored on Microsoft Azure or AWS S3."]}),"\n",(0,n.jsxs)(s,{children:[(0,n.jsx)("summary",{children:(0,n.jsx)(t.p,{children:(0,n.jsx)(t.strong,{children:"Installation requirements"})})}),(0,n.jsxs)(t.p,{children:["To follow along with these examples, you should have ",(0,n.jsx)(t.a,{href:"https://jupyter.org/",children:"JupyterLab or Jupyter Notebook"})," running and the following dependencies installed:"]}),(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://pandas.pydata.org/",children:"Pandas"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://geopandas.org/en/stable/index.html",children:"GeoPandas"})}),"\n",(0,n.jsx)(t.li,{children:(0,n.jsx)(t.a,{href:"https://shapely.readthedocs.io/en/stable/index.html",children:"Shapely"})}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.a,{href:"https://duckdb.org/",children:"DuckDB"}),", ",(0,n.jsx)(t.a,{href:"https://duckdb.org/docs/extensions/spatial.html",children:"DuckDB spatial extension"}),", and ",(0,n.jsx)(t.a,{href:"https://duckdb.org/docs/extensions/aws.html",children:"DuckDB AWS extension"})," or ",(0,n.jsx)(t.a,{href:"https://duckdb.org/docs/extensions/azure.html",children:"DuckDB azure extension"}),"."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.a,{href:"https://jupysql.ploomber.io/en/latest/quick-start.html",children:"JupySQL"})," (optional)"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.a,{href:"https://github.com/Mause/duckdb_engine",children:"duckdb-engine"})," (optional)"]}),"\n"]})]}),"\n",(0,n.jsxs)(t.p,{children:["A executable version of this notebook is available on ",(0,n.jsx)(t.a,{href:"https://notebooksharing.space/view/1d0d72d24ed82d22a8101377ca811ab7365b6a67dac98f3add034719c44b537f#displayOptions=",children:"Notebook Sharing Space"}),". More examples are available in ",(0,n.jsx)(t.a,{href:"https://docs.overturemaps.org/",children:"the notebooks directory"})," in our docs repository on GitHub."]}),"\n",(0,n.jsx)(t.h2,{id:"example",children:"Example"}),"\n",(0,n.jsx)(t.p,{children:"Let's start by importing our toolkit."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"# import our toolkit\nimport pandas as pd\nimport geopandas as gpd\nfrom shapely import wkt\nimport duckdb\n"})}),"\n",(0,n.jsx)(t.p,{children:"Next, we'll install and load DuckDB extensions to work with spatial data and connect to AWS. (Or you can use the Azure extension to connect to the Overture data stores on Azure.)"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"%sql INSTALL spatial;\n%sql INSTALL httpfs;\n%sql LOAD spatial;\n%sql LOAD httpfs;\n%sql SET s3_region='us-west-2'\n"})}),"\n",(0,n.jsxs)(t.p,{children:["The DuckDB documentation offers tips and examples for ",(0,n.jsx)(t.a,{href:"https://duckdb.org/docs/guides/python/jupyter.html",children:"running DuckDB queries in Jupyter notebooks"}),". In this example, we're using duckdb-engine and JupySQL. You can also connect to DuckDB natively."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"# no need to import duckdb_engine, JupySQL will auto-detect driver \n# load (or reload) jupysql Jupyter extension to create SQL cells\n%reload_ext sql\n"})}),"\n",(0,n.jsx)(t.p,{children:"We can set the configurations on JupySQL to directly output data to Pandas and to simplify the output that is printed to the notebook."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"%config SqlMagic.autopandas = True\n%config SqlMagic.feedback = False\n%config SqlMagic.displaycon = False\n"})}),"\n",(0,n.jsx)(t.p,{children:"Connect JupySQL to DuckDB using a SQLAlchemy-style connection string."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"# DuckDB in-memory database\n%sql duckdb://\n"})}),"\n",(0,n.jsx)(t.p,{children:"Now we're going to extract data from Overture's base theme for an area along the Gulf Coast. The magic %%sql command turns the notebook cell into a SQL cell and allows us to dump our query results in a Pandas DataFrame. Note: this query takes about a minute run."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"%%sql gulf_water <<\nSELECT \n    id, \n    names.primary AS primary_name,\n    ST_AsText(ST_GeomFromWKB(geometry)) as geometry \nFROM \n    read_parquet('s3://overturemaps-us-west-2/release/2024-07-22.0/theme=base/type=water/*', filename=true, hive_partitioning=1)\nWHERE \n    bbox.xmin >= -91.3994\n        and bbox.xmax <= -89.3864\n        and bbox.ymin >= 29.152\n        and bbox.ymax <= 30.5161\n"})}),"\n",(0,n.jsx)(t.p,{children:"Before we move on, let's deal with the geometry we pulled out of Overture's GeoParquet file. Geometry columns in GeoParquet are stored in binary format. In the above query, we transformed that geometry into text, and now we need to turn it into a Shapely geometry to get it into our GeoDataFrame. Here's how we do that."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"gulf_water['geometry'] = gulf_water['geometry'].apply(wkt.loads)\n\n# dataframe to geodataframe, set crs\ngulf_water_gdf = gpd.GeoDataFrame(\n    gulf_water\n    , geometry='geometry', crs=\"EPSG:4326\"\n)\n"})}),"\n",(0,n.jsx)(t.p,{children:"Let's work with just the water polygons and lines, not the points."}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:"# Apply a lambda to remove point geometries\ngulf_water_gdf = gulf_water_gdf[gulf_water_gdf['geometry'].apply(lambda x : x.geom_type!='Point' )]\n"})}),"\n",(0,n.jsx)(t.p,{children:"Let's make a quick plot of the data. Voil\xe0!"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",children:'gulf_water_gdf.plot(facecolor="#628290", edgecolor="#006064", lw=0.05)\n'})}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"gulf bay",src:a(86957).A+"",width:"1624",height:"1116"})}),"\n",(0,n.jsx)(t.h2,{id:"next-steps",children:"Next steps"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Want to speed things up and work with larger extracts of Overture data? Check out our ",(0,n.jsx)(t.a,{href:"../lonboard",children:"Lonboard tutorial"}),"."]}),"\n"]})]})}function c(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},19365:(e,t,a)=>{a.r(t),a.d(t,{default:()=>o});a(96540);var n=a(18215);const r={tabItem:"tabItem_Ymn6"};var s=a(74848);function o(e){let{children:t,hidden:a,className:o}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,n.A)(r.tabItem,o),hidden:a,children:t})}},11470:(e,t,a)=>{a.r(t),a.d(t,{default:()=>w});var n=a(96540),r=a(18215),s=a(23104),o=a(56347),l=a(205),i=a(57485),u=a(31682),d=a(89466);function c(e){return n.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,n.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:t,children:a}=e;return(0,n.useMemo)((()=>{const e=t??function(e){return c(e).map((e=>{let{props:{value:t,label:a,attributes:n,default:r}}=e;return{value:t,label:a,attributes:n,default:r}}))}(a);return function(e){const t=(0,u.X)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,a])}function p(e){let{value:t,tabValues:a}=e;return a.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:a}=e;const r=(0,o.W6)(),s=function(e){let{queryString:t=!1,groupId:a}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return a??null}({queryString:t,groupId:a});return[(0,i.aZ)(s),(0,n.useCallback)((e=>{if(!s)return;const t=new URLSearchParams(r.location.search);t.set(s,e),r.replace({...r.location,search:t.toString()})}),[s,r])]}function f(e){const{defaultValue:t,queryString:a=!1,groupId:r}=e,s=h(e),[o,i]=(0,n.useState)((()=>function(e){let{defaultValue:t,tabValues:a}=e;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!p({value:t,tabValues:a}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${a.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const n=a.find((e=>e.default))??a[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:t,tabValues:s}))),[u,c]=m({queryString:a,groupId:r}),[f,g]=function(e){let{groupId:t}=e;const a=function(e){return e?`docusaurus.tab.${e}`:null}(t),[r,s]=(0,d.Dv)(a);return[r,(0,n.useCallback)((e=>{a&&s.set(e)}),[a,s])]}({groupId:r}),x=(()=>{const e=u??f;return p({value:e,tabValues:s})?e:null})();(0,l.A)((()=>{x&&i(x)}),[x]);return{selectedValue:o,selectValue:(0,n.useCallback)((e=>{if(!p({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);i(e),c(e),g(e)}),[c,g,s]),tabValues:s}}var g=a(92303);const x={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=a(74848);function y(e){let{className:t,block:a,selectedValue:n,selectValue:o,tabValues:l}=e;const i=[],{blockElementScrollPositionUntilNextRender:u}=(0,s.a_)(),d=e=>{const t=e.currentTarget,a=i.indexOf(t),r=l[a].value;r!==n&&(u(t),o(r))},c=e=>{let t=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{const a=i.indexOf(e.currentTarget)+1;t=i[a]??i[0];break}case"ArrowLeft":{const a=i.indexOf(e.currentTarget)-1;t=i[a]??i[i.length-1];break}}t?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":a},t),children:l.map((e=>{let{value:t,label:a,attributes:s}=e;return(0,b.jsx)("li",{role:"tab",tabIndex:n===t?0:-1,"aria-selected":n===t,ref:e=>i.push(e),onKeyDown:c,onClick:d,...s,className:(0,r.A)("tabs__item",x.tabItem,s?.className,{"tabs__item--active":n===t}),children:a??t},t)}))})}function j(e){let{lazy:t,children:a,selectedValue:r}=e;const s=(Array.isArray(a)?a:[a]).filter(Boolean);if(t){const e=s.find((e=>e.props.value===r));return e?(0,n.cloneElement)(e,{className:"margin-top--md"}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:s.map(((e,t)=>(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==r})))})}function v(e){const t=f(e);return(0,b.jsxs)("div",{className:(0,r.A)("tabs-container",x.tabList),children:[(0,b.jsx)(y,{...t,...e}),(0,b.jsx)(j,{...t,...e})]})}function w(e){const t=(0,g.A)();return(0,b.jsx)(v,{...e,children:c(e.children)},String(t))}},86957:(e,t,a)=>{a.d(t,{A:()=>n});const n=a.p+"assets/images/gulf-water-8d0bddd4738cbde0dcd61720df26728a.png"}}]);