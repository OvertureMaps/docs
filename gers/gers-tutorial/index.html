<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-gers/gers-tutorial" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">GERS Tutorial | Overture Maps Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://docs.overturemaps.org/img/omf_logo_transparent.png"><meta data-rh="true" name="twitter:image" content="https://docs.overturemaps.org/img/omf_logo_transparent.png"><meta data-rh="true" property="og:url" content="https://docs.overturemaps.org/gers/gers-tutorial/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="GERS Tutorial | Overture Maps Documentation"><meta data-rh="true" name="description" content="Why associate your data with GERS identifiers?"><meta data-rh="true" property="og:description" content="Why associate your data with GERS identifiers?"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://docs.overturemaps.org/gers/gers-tutorial/"><link data-rh="true" rel="alternate" href="https://docs.overturemaps.org/gers/gers-tutorial/" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs.overturemaps.org/gers/gers-tutorial/" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://MK8X1051PQ-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Overture Maps Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Overture Maps Documentation Atom Feed">




<link rel="search" type="application/opensearchdescription+xml" title="Overture Maps Documentation" href="/opensearch.xml">

<link rel="alternate" type="application/rss+xml" href="/release/rss.xml" title="Overture Maps Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/release/atom.xml" title="Overture Maps Documentation Atom Feed"><link rel="stylesheet" href="/assets/css/styles.d8101035.css">
<script src="/assets/js/runtime~main.e2257d9b.js" defer="defer"></script>
<script src="/assets/js/main.20046d82.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://overturemaps.org" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/img/omf_logo_transparent.png" alt="Overture Maps Foundation Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/omf_logo_transparent.png" alt="Overture Maps Foundation Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Overture Maps</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Docs</a><a class="navbar__item navbar__link" href="/schema/">Schema Reference</a><a class="navbar__item navbar__link" href="/release/latest/">Releases</a><a class="navbar__item navbar__link" href="/blog/">Blog</a><a class="navbar__item navbar__link" href="/community/">Community</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/OvertureMaps/docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link github-link"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/getting-data/">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/examples/">Examples</a><button aria-label="Expand sidebar category &#x27;Examples&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/guides/">Data Guides</a><button aria-label="Expand sidebar category &#x27;Data Guides&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/gers/">Global Entity Reference System</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gers/">What is GERS?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gers/changelog/">Data Changelog</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gers/gers-demonstrations/">GERS Demonstrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/gers/gers-tutorial/">GERS Tutorial</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/attribution/">Attribution and Licensing</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Global Entity Reference System</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">GERS Tutorial</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>GERS Tutorial</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="why-associate-your-data-with-gers-identifiers">Why associate your data with GERS identifiers?<a href="#why-associate-your-data-with-gers-identifiers" class="hash-link" aria-label="Direct link to Why associate your data with GERS identifiers?" title="Direct link to Why associate your data with GERS identifiers?">​</a></h2>
<p>The Overture Maps Foundation doesn’t just produce a collection of open datasets, it defines a reference system for exchanging and enriching geospatial data. This reference system, called GERS (Geospatial Entity Reference System), provides persistent unique identifiers for each map feature in Overture’s datasets.</p>
<p>By matching your data to Overture’s and attaching GERS identifiers to your datapoints, you can share and connect your data with other GERS-associated datasets.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="process-overview">Process overview<a href="#process-overview" class="hash-link" aria-label="Direct link to Process overview" title="Direct link to Process overview">​</a></h2>
<p>To associate your data with GERS identifiers, we need to:</p>
<ol>
<li>Perform an initial association between your data and a relevant Overture theme.</li>
<li>Add GERS identifiers to your dataset as a column or produce a “bridge file” mapping your data identifiers to their corresponding GERS identifiers.</li>
<li>Perform a regular maintenance match, usually with every monthly Overture release.</li>
</ol>
<p>Joining geospatial datasets is a highly context dependent task. Sometimes you want very precise matches, with little risk of false positives. And other times you want greedy, loose matches, with wide coverage. To demonstrate this context dependency, we’ll be adopting the following use case to frame our decisions:</p>
<p><em>We’re building a hyperlocal mobile application that allows people to browse restaurants in Alameda County. Users can search for, browse, bookmark, and share restaurants. We will be using <a href="https://docs.overturemaps.org/guides/places/" target="_blank" rel="noopener noreferrer">Overture’s Places theme</a> as our foundational dataset, but we want to bring in additional datasets to add details to our restaurant listings.</em></p>
<p>One dataset we want to add is <a href="https://data.acgov.org/datasets/e95ff2829e9d4ea0b3d8266aac37ff14_0/explore" target="_blank" rel="noopener noreferrer">Alameda County’s restaurant inspection reports</a>, a dataset detailing the health and safety scores for each restaurant. This data will allow our users to filter restaurants by their health scores and present these health scores in our restaurant profiles.</p>
<p>The following tutorial walks through how to join this dataset to Overture&#x27;s places, both as a one-off connection and an ongoing match process.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="performing-an-initial-match">Performing an initial match<a href="#performing-an-initial-match" class="hash-link" aria-label="Direct link to Performing an initial match" title="Direct link to Performing an initial match">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="planning-our-match">Planning our match<a href="#planning-our-match" class="hash-link" aria-label="Direct link to Planning our match" title="Direct link to Planning our match">​</a></h3>
<p>Alameda County produces and publishes a dataset detailing restaurant inspections. These records are regularly updated and specify the current “health score” of a given venue. The county publishes these records in a variety of formats; today we’ll be using their GeoJSON distribution.</p>
<p>In the GeoJSON file, records are stored as features. For example:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;type&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;Feature&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;id&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">3</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;geometry&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;type&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;Point&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;coordinates&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">                   </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token number" style="color:rgb(170, 9, 130)">122.056105500269</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">                   </span><span class="token number" style="color:rgb(170, 9, 130)">37.6374869997196</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;properties&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;OBJECTID&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">3</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Facility_ID&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;FA0319719&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;ExternalID&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">827161</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Facility_Name&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;LALO&#x27;S TAQUERIA&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Address&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;28293 MISSION BLVD&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;City&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;HAYWARD&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;State&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;CA&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Zip&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;94544&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Activity_Date&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;2024-01-18&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Service&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;111&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Violation_Description&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;Food in good condition, safe and unadulterated&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Grade&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;G&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Longitude&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token number" style="color:rgb(170, 9, 130)">122.0561055</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;Latitude&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">37.637487</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you’re following along, go ahead and download <a href="https://data.acgov.org/datasets/e95ff2829e9d4ea0b3d8266aac37ff14_0/explore?location=37.676900%2C-122.008949%2C10.04" target="_blank" rel="noopener noreferrer">the GeoJSON data from Alameda County’s portal</a>.</p>
<p>Inspection records are associated with restaurants and eateries, so it makes sense to associate these records with Overture’s Places theme.</p>
<p>In the Overture places dataset, the record which matches the inspection example above looks like this, in GeoJSON form:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">   </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;type&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;Feature&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">   </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;geometry&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;type&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;Point&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;coordinates&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token number" style="color:rgb(170, 9, 130)">122.056054</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token number" style="color:rgb(170, 9, 130)">37.63755</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">   </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;properties&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;id&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;08f28346e8ca018503160340e65ac7b6&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;type&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;place&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;version&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;sources&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;property&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;dataset&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;meta&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;record_id&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;103711722756889&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;update_time&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;2025-02-24T08:00:00.000Z&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;confidence&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.9793990828827596</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;names&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;primary&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;Lalo&#x27;s Taqueria&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;common&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(12, 150, 155)">null</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;rules&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token keyword null nil" style="color:rgb(12, 150, 155)">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;categories&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;primary&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;mexican_restaurant&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;alternate&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;restaurant&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;eat_and_drink&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;confidence&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.9793990828827596</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;socials&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;https://www.facebook.com/103711722756889&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;phones&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;+15109400137&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;addresses&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(153, 76, 195)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;freeform&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;28293 Mission Blvd&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;locality&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;Hayward&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;postcode&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;94544-4853&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;region&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;CA&quot;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">               </span><span class="token string-property property" style="color:rgb(12, 150, 155)">&quot;country&quot;</span><span class="token operator" style="color:rgb(12, 150, 155)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&quot;US&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">       </span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Comparing the schema of each, we can see there are a few elements we can reference during our match:</p>
<p><img decoding="async" loading="lazy" alt="schema-comparison" src="/assets/images/schema-comparison-43ccfb5b7dbe7900b2e890ddba6bdc4c.png" width="1146" height="794" class="img_ev3q"></p>
<p>Using these common properties, and a bit of SQL, we can spin up a quick matcher using DuckDB.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="staging-our-datasets">Staging our datasets<a href="#staging-our-datasets" class="hash-link" aria-label="Direct link to Staging our datasets" title="Direct link to Staging our datasets">​</a></h3>
<p>With our inspection data saved as <code>inspection_records.geojson</code>, let’s boot up <a href="/getting-data/duckdb/">DuckDB</a>, specifying a local database as a cache.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">$ duckdb inspection_match.ddb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We’ll load DuckDB&#x27;s <code>spatial</code> and <code>httpfs</code> plug-ins, then load our inspections into a local table.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">D install spatial</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">load</span><span class="token plain"> spatial</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">D install httpfs</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">load</span><span class="token plain"> httpfs</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> inspections </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> ST_Read</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;inspection_records.geojson&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since there are multiple inspections for each venue, and we want to match each venue to an Overture place, we’re going to create a separate table just for the facilities.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> facilities </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> State</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> Zip</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> geom</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> inspections</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> State</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> Zip</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>We’re only pulling in each facility&#x27;s ID and the columns which overlap with Overture’s places.</p></div></div>
<p>Geospatial matching processes can get quite complex, so we’re going to load the Overture data we need in a local table before attempting any joins.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> places </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">WITH</span><span class="token plain"> bounding_box </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">max</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_Y</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> max_lat</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">min</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_Y</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> min_lat</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">max</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_X</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> max_lon</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">           </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">min</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_X</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> min_lon</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">names</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;primary&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;freeform&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;locality&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;region&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> State</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">left</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;postcode&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">5</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> Zip</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">geometry</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    categories</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    confidence </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> read_parquet</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;s3://overturemaps-us-west-2/release/2025-04-23.0/theme=places/type=place/*&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> filename</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token boolean" style="color:rgb(188, 84, 84)">true</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> hive_partitioning</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      bounding_box</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> bbox</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">xmin </span><span class="token operator" style="color:rgb(12, 150, 155)">BETWEEN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">min_lon </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">max_lon </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> bbox</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">ymin </span><span class="token operator" style="color:rgb(12, 150, 155)">BETWEEN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">min_lat </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">max_lat </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We’re doing several things here that are worth breaking down:</p>
<ol>
<li>We create a bounding box by computing the maximum and minimum latitude and longitude values of our inspections. This ensures we’re only pulling Overture Places relevant to our input dataset.</li>
<li>Our following <code>SELECT</code> statement prepares the Places data to more closely align with the conventions of our inspections data: the <code>addresses</code> column is broken down into component columns and we use only the primary name from the <code>names</code> column and label it to match <code>Facility_Name</code>.</li>
<li>Finally, we obtain the data from the Overture S3 bucket by remotely reading the parquet. A <code>WHERE</code> statement limits our request to a slightly buffered bounding box (buffered to ensure we’re capturing places near those facilities on the edges of our dataset).</li>
</ol>
<p>We now have three tables: <code>inspections</code> with 27,515 records, <code>facilities</code> with 4,340 records, and <code>places</code> with 73,985 records.</p>
<p>Before we work on connecting them, we’ll add some spatial indexes to each table, making our lookups much faster:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> idx_places_geometry </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> places </span><span class="token keyword" style="color:rgb(12, 150, 155)">USING</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">RTREE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> idx_facilities_geometry </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> facilities </span><span class="token keyword" style="color:rgb(12, 150, 155)">USING</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">RTREE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="matching-our-data">Matching our data<a href="#matching-our-data" class="hash-link" aria-label="Direct link to Matching our data" title="Direct link to Matching our data">​</a></h3>
<p>Geospatial matching can be a simple or very complicated process. A simple join might just be a couple <code>WHERE</code> statements, while a complicated process might employ a compound pipeline with  Bayesian comparisons, vector search, LLMs, and/or human reviewers. It all depends on your use case.</p>
<p>Geospatial matching can also be <em>greedy</em> or <em>cautious</em>. A greedy matching routine will have less stringent standards and err towards making mismatches, whereas a cautious match will apply strict standards and err towards missing a correct match.</p>
<p>What type of match you employ — simple or complicated, greedy or cautious — requires you to understand how your data is being used, the cost of a false positive, and more. This is to say: it’s a decision beyond the scope of this tutorial.</p>
<p>For our example, we will be constructing a <em>simple cautious</em> matcher. We’ve chosen to build a cautious matcher because our data describes inspection scores and violations; the cost of a false match is <em>high</em>. It is safer for us to show <em>no</em> health score than show a <em>failing</em> one for a restaurant that did not fail.</p>
<p>But to get started, we will write a join using three conditions with very loose thresholds. We’ll break down each condition below.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">confidence </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> overture_confidence</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    ST_Distance_Sphere</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> distance</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> name_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> address_similarity</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities f</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> places p</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> ST_DWithin</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.001</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.7</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> distance</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Scanning down to the <code>JOIN</code> statement, we are using three comparisons to associate our records:</p>
<ol>
<li>
<p><strong>Is it close by?</strong> <code>ST_DWithin(f.geom, p.geom, 0.005)</code>: This matches records if they’re within ~100 meters from each other (this is what 0.001 roughly equates to in our <a href="https://en.wikipedia.org/wiki/Spatial_reference_system" target="_blank" rel="noopener noreferrer">SRID</a>)</p>
</li>
<li>
<p><strong>Do the names match?</strong> <code>jaro_winkler_similarity(f.Facility_Name, p.Facility_Name) &gt; 0.7</code>: This is a <a href="https://en.wikipedia.org/wiki/Jaro%E2%80%93Winkler_distance" target="_blank" rel="noopener noreferrer">string comparison function</a> that generates a score from 0.0 to 1.0, with 1.0 being an exact match. Here we’re comparing the listed name for each record. We’ve chosen the Jaro-Winkler metric because it weights the beginning of strings higher than the end of strings, which tends to work well here.</p>
</li>
<li>
<p><strong>Do the addresses match?</strong> <code>jaro_winker_similarity(f.Address, p.Address) &gt; 0.8</code>: We’re using the same function as the previous comparison, just with a slightly higher threshold, to compare our addresses.</p>
</li>
</ol>
<p>With just this query, we can get pretty far. There are three levers — the values specified for each of the three statements above — that we can tweak until we’re close to good.</p>
<p>At this point, it’s helpful to look at the data yourself. I usually use <a href="https://duckdb.org/docs/stable/guides/file_formats/csv_export.html" target="_blank" rel="noopener noreferrer">DuckDB’s CSV export function</a> and scan the results, looking for patterns to inform tweaking our parameters.</p>
<p>For example, here are 3 candidate Overture Places which match with “Thornhill Coffee Shop”, located at 5772 Thornhill Drive.</p>
<table><thead><tr><th>Name</th><th>Address</th><th>Distance</th><th>Name Similarity</th><th>Address Similarity</th></tr></thead><tbody><tr><td>THORNHILL COFFEE HOUSE</td><td>5772 THORNHILL DR</td><td>35.52</td><td>0.96</td><td>1.00</td></tr><tr><td>THORNHILL SALON</td><td>5736 THORNHILL DR</td><td>41.46</td><td>0.85</td><td>0.93</td></tr><tr><td>THORNHILL PET HOSPITAL</td><td>5745 THORNHILL DR</td><td>70.93</td><td>0.87</td><td>0.93</td></tr></tbody></table>
<p>Here, everything is functioning as it should be. Even though our matcher is looser (it’s letting in the two wrong candidates), the distance, name similarity, and address similarity metrics allow us to easily order our results and allow the correct record to bubble up.</p>
<p>But elsewhere, this is not the case. Consider this example for matches with “West Oakland Senior Center”, 1724 Adeline Street:</p>
<table><thead><tr><th>Name</th><th>Address</th><th>Distance</th><th>Name Similarity</th><th>Address Similarity</th></tr></thead><tbody><tr><td>WEST OAKLAND BRANCH</td><td>1801 ADELINE ST</td><td>55.85</td><td>0.87</td><td>0.88</td></tr><tr><td>WEST OAKLAND JOB RESOURCE CENTER</td><td>1801 ADELINE ST</td><td>56.17</td><td>0.90</td><td>0.88</td></tr><tr><td>WEST OAKLAND SENIOR CENTER</td><td>1724 ADELINE ST</td><td>64.24</td><td>1.0</td><td>1.0</td></tr></tbody></table>
<p>In this example, ranking in descending order of distance puts the correct match at the bottom. This cluster of match candidates suggests a perfect match for name and address should overrule slight distance differences.</p>
<p>Reviewing these cluster candidates is essential work when building a matcher. As you plot and peruse them, patterns will emerge, enabling you to better tune your parameters.</p>
<p>For larger matches — beyond the scale of ~4,000 restaurants in a single county — we recommend building evaluation test sets: human-verified correct and incorrect match pairs for a sample of your data. With an evaluation test set, one can more systematically tweak their matcher and quantitatively measure their performance.</p>
<p>But for our restaurant app scenario, we’re fine with a quick match to populate our listings. After reviewing the data and running a few adjusted queries, we landed on an effective <em>simple conservative</em> matcher query:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">WITH</span><span class="token plain"> ranked_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">confidence </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> overture_confidence</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    ST_Distance_Sphere</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> distance</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> name_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> address_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    ROW_NUMBER</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">OVER</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token keyword" style="color:rgb(12, 150, 155)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">      </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> rank</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities f</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> places p</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> ST_DWithin</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.001</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.89</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.75</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> ranked_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> rank </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This query yields 2,358 correct matches and no false positives, for a match rate of 55%. By adding more conditionals and stages, we could get much higher results (if you’d like the details about that, <a href="https://www.dbreunig.com/2024/09/27/conflating-overture-points-of-interests-with-duckdb-ollama-and-more.html" target="_blank" rel="noopener noreferrer">check out a longer exploration here</a>), but for our restaurant listing app, this suits our needs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="enriching-data-with-gers-ids--producing-a-bridge-file">Enriching data with GERS IDs &amp; producing a bridge file<a href="#enriching-data-with-gers-ids--producing-a-bridge-file" class="hash-link" aria-label="Direct link to Enriching data with GERS IDs &amp; producing a bridge file" title="Direct link to Enriching data with GERS IDs &amp; producing a bridge file">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enriching-our-table">Enriching our table<a href="#enriching-our-table" class="hash-link" aria-label="Direct link to Enriching our table" title="Direct link to Enriching our table">​</a></h3>
<p>With our matcher written and tuned, let’s add a column to our <code>facilities</code> table named <code>gers_id</code> and populate it with our join query above:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> inspections </span><span class="token keyword" style="color:rgb(12, 150, 155)">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">COLUMN</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">geometry</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> inspections </span><span class="token keyword" style="color:rgb(12, 150, 155)">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">COLUMN</span><span class="token plain"> gers_id </span><span class="token keyword" style="color:rgb(12, 150, 155)">VARCHAR</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">WITH</span><span class="token plain"> ranked_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">confidence </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> overture_confidence</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        ST_Distance_Sphere</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> distance</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> name_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> address_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        ROW_NUMBER</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">OVER</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">            </span><span class="token keyword" style="color:rgb(12, 150, 155)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">            </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> rank</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities f</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> places p</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> ST_DWithin</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.001</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.89</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.75</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">selected_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> match_id </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> ranked_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> rank </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">UPDATE</span><span class="token plain"> inspections i </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> gers_id </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">match_id </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> selected_matches sm </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Our <code>facilities</code> table is now enriched with GERS identifiers.</p>
<p>We can use this association to connect county health scores with our Overture Places basemap, then display them to our app users.</p>
<p>Further, if we can share our association with others, allowing them to benefit from the hard work we’ve done matching this data and easily connect it to their GERS-associated datasets using only a column join. One way to facilitate this is a <em>bridge file</em>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="producing-a-bridge-file">Producing a bridge file<a href="#producing-a-bridge-file" class="hash-link" aria-label="Direct link to Producing a bridge file" title="Direct link to Producing a bridge file">​</a></h3>
<p>A bridge file is a join table, connecting GERS identifiers with another set of identifiers. Overture produces bridge files for the data sources we use to produce our datasets, allowing others to understand the provenance of our data and to quickly enrich their own data with Overture datasets, if they’re currently using one of our input data sources.</p>
<p>Once you’ve enriched your dataset with GERS identifiers, you can produce a bridge file like this:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> gers_id </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> inspections </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> gers_id </span><span class="token operator" style="color:rgb(12, 150, 155)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> gers_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Output this query as a CSV or parquet file and you’re done. It looks like this:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">Facility_ID,gers_id</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">FA0319719,08f28346e8ca018503160340e65ac7b6</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">FA0319719,08f28346e8ca018503160340e65ac7b6</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">FA0319719,08f28346e8ca018503160340e65ac7b6</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">FA0002404,08f283098d6527200394e5ac0b19dbf5</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">FA0002404,08f283098d6527200394e5ac0b19dbf5</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="performing-a-maintenance-match">Performing a maintenance match<a href="#performing-a-maintenance-match" class="hash-link" aria-label="Direct link to Performing a maintenance match" title="Direct link to Performing a maintenance match">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="associating-with-every-monthly-release">Associating with every monthly release<a href="#associating-with-every-monthly-release" class="hash-link" aria-label="Direct link to Associating with every monthly release" title="Direct link to Associating with every monthly release">​</a></h3>
<p>Overture currently releases a new version of its data every month. Our <a href="https://docs.overturemaps.org/release/latest/" target="_blank" rel="noopener noreferrer">releases page</a> specifies its location and provides release notes.</p>
<p><strong>Geospatial data never sleeps</strong>. The real world is constantly changing, and in our case, restaurants are continually being opened and closed. Further, as Overture onboards new sources of data, the quality and coverage of our releases improves.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Regularly associating your data with Overture’s is considered best practice.</p></div></div>
<p>While rerunning a match for our ~4,000 restaurants is relatively quick, larger dataset associations can be quite costly. Thankfully, there are a few things we can take advantage of to make this process easier.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="overture-data-changelog">Overture data changelog<a href="#overture-data-changelog" class="hash-link" aria-label="Direct link to Overture data changelog" title="Direct link to Overture data changelog">​</a></h3>
<p>With each data release, Overture generates a <a href="https://docs.overturemaps.org/gers/changelog/" target="_blank" rel="noopener noreferrer">data changelog</a> to capture changes in the data tied to the GERS ID for each feature. This information can be used to help reduce the scope of our maintenance match by identifying associated GERS IDs which have changed.</p>
<p>Using our same DuckDB database, we can remotely query the current changelog using a bounding box defined by our inspections dataset.</p>
<p>But wait — using the current April changelog won’t yield very interesting results, since we’ve already matched against the April data. For this exercise we’ll redo our work above, this time referencing the previous, March, Overture release.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="finding-a-subset-of-records-that-need-matching">Finding a subset of records that need matching<a href="#finding-a-subset-of-records-that-need-matching" class="hash-link" aria-label="Direct link to Finding a subset of records that need matching" title="Direct link to Finding a subset of records that need matching">​</a></h3>
<p>Matching against the March data, we connect 2,366 of our facility IDs to GERS IDs. Let’s see how the April changelog can help during our maintenance match.</p>
<p>First, we’ll cache the changelog in a table, filtered again by a bounding box:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> changes </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">WITH</span><span class="token plain"> bounding_box </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">max</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_Y</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> max_lat</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">min</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_Y</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> min_lat</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">max</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_X</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> max_lon</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">min</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_X</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> min_lon</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> bbox</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> filename</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> change_type</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> theme </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> read_parquet</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;s3://overturemaps-us-west-2/changelog/2025-03-19.1/theme=places/type=place/change_type=*/*&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> filename</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token boolean" style="color:rgb(188, 84, 84)">true</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> hive_partitioning</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">            bounding_box</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        bbox</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">xmin </span><span class="token operator" style="color:rgb(12, 150, 155)">BETWEEN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">min_lon </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">max_lon </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        bbox</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">ymin </span><span class="token operator" style="color:rgb(12, 150, 155)">BETWEEN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">min_lat </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">max_lat </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This loads 87,229 records, which we’ll now intersect with our existing, associated GERS IDs:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> gers_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> change_type </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> inspections i </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> changes c</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">gers_id </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> gers_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> change_type</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Of our 2,366 associated GERS, 61% are <code>unchanged</code>. 37% have had <code>data_changed</code>, in some form or another, but Overture’s matchers have determined their GERS ID should persist, indicating that the record refers to the same entity.</p>
<p>But ~1.5% of our matched GERS IDs — or 37 records — have been <code>removed</code>. This could indicate a business has closed or a data record was identified as incorrect. Either way, this is a very small subset of records that we should rematch.</p>
<p>Given our use case and our desire to produce a cautious match, we will also be rematching against the <code>data_changed</code> records. There are many cases where a data update could correct an over-eager match based on incorrect input data.</p>
<p>For our county restaurant inspection use case, our data volumes aren’t of a sufficient size to really bother with this nuance (it’s easier to just rematch against the new release and quickly compare the output to make sure nothing is breaking). But for much larger datasets, where matching routines might take hours, this list of <code>removed</code> and <code>data_changed</code> records is valuable.</p>
<p>Let’s build a new query which finds the subset of the facilities IDs we should rematch. It’s similar to our last one:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> gers_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> change_type </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> inspections i </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> changes c</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">gers_id </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> change_type </span><span class="token operator" style="color:rgb(12, 150, 155)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">OR</span><span class="token plain"> change_type </span><span class="token operator" style="color:rgb(12, 150, 155)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;removed&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;data_changed&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> Facility_ID</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> gers_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> change_type</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We’re using a <code>LEFT JOIN</code> in this query to find the <code>Facility_ID</code>s which don’t have associated GERS IDS (hence, they might match with a new Overture release) and only selecting those matched records where the associated GERS ID has been removed.</p>
<p>This gives us 2,804 facilities we need to match.</p>
<p>To simplify our SQL, we’ll save the results from the above query as <code>facilities_to_match</code>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="matching-unmatched-records-to-the-latest-release">Matching unmatched records to the latest release<a href="#matching-unmatched-records-to-the-latest-release" class="hash-link" aria-label="Direct link to Matching unmatched records to the latest release" title="Direct link to Matching unmatched records to the latest release">​</a></h4>
<p>Armed with a shopping list of unmatched facilities, we can now drop our <code>places</code> table and refresh it with the April Overture data, then create our spatial index.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> places</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">TABLE</span><span class="token plain"> places </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">WITH</span><span class="token plain"> bounding_box </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">max</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_Y</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> max_lat</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">min</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_Y</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> min_lat</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">max</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_X</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> max_lon</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(153, 76, 195);font-style:italic">min</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">ST_X</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> min_lon</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">names</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;primary&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;freeform&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;locality&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> City</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    upper</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;region&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> State</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">left</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;postcode&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">5</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> Zip</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">geometry</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    confidence</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    categories </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">  </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">*</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> read_parquet</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token string" style="color:rgb(72, 118, 214)">&#x27;s3://overturemaps-us-west-2/release/2025-04-23.0/theme=places/type=place/*&#x27;</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> filename</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token boolean" style="color:rgb(188, 84, 84)">true</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> hive_partitioning</span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">            bounding_box</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> addresses</span><span class="token punctuation" style="color:rgb(153, 76, 195)">[</span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token punctuation" style="color:rgb(153, 76, 195)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(188, 84, 84)">NULL</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        bbox</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">xmin </span><span class="token operator" style="color:rgb(12, 150, 155)">BETWEEN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">min_lon </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">max_lon </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        bbox</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">ymin </span><span class="token operator" style="color:rgb(12, 150, 155)">BETWEEN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">min_lat </span><span class="token operator" style="color:rgb(12, 150, 155)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">bounding_box</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">max_lat </span><span class="token operator" style="color:rgb(12, 150, 155)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.01</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        confidence </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">D </span><span class="token keyword" style="color:rgb(12, 150, 155)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">INDEX</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">EXISTS</span><span class="token plain"> idx_places_geometry </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> places </span><span class="token keyword" style="color:rgb(12, 150, 155)">USING</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">RTREE</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, we run our match query again, limiting it to only those facilities in <code>facilities_to_match</code>.</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#403f53;--prism-background-color:#FBFBFB"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">WITH</span><span class="token plain"> ranked_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> input_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">id </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> match_address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">confidence </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> overture_confidence</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        ST_Distance_Sphere</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> distance</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> name_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> address_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        ROW_NUMBER</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">OVER</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">            </span><span class="token keyword" style="color:rgb(12, 150, 155)">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">            </span><span class="token keyword" style="color:rgb(12, 150, 155)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">BY</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(12, 150, 155)">as</span><span class="token plain"> rank</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities f</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">JOIN</span><span class="token plain"> places p</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token keyword" style="color:rgb(12, 150, 155)">ON</span><span class="token plain"> ST_DWithin</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">geom</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.001</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_Name</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.89</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">        </span><span class="token operator" style="color:rgb(12, 150, 155)">AND</span><span class="token plain"> jaro_winkler_similarity</span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain">f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">0.75</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID </span><span class="token operator" style="color:rgb(12, 150, 155)">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> Facility_ID </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> facilities_to_match</span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">selected_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(153, 76, 195)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain">    </span><span class="token keyword" style="color:rgb(12, 150, 155)">SELECT</span><span class="token plain"> input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">,</span><span class="token plain"> match_id </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> ranked_matches </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> rank </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(170, 9, 130)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token punctuation" style="color:rgb(153, 76, 195)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">UPDATE</span><span class="token plain"> inspections i </span><span class="token keyword" style="color:rgb(12, 150, 155)">SET</span><span class="token plain"> gers_id </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">match_id </span><span class="token keyword" style="color:rgb(12, 150, 155)">FROM</span><span class="token plain"> selected_matches sm </span><span class="token keyword" style="color:rgb(12, 150, 155)">WHERE</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">Facility_ID </span><span class="token operator" style="color:rgb(12, 150, 155)">=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:rgb(153, 76, 195)">.</span><span class="token plain">input_id</span><span class="token punctuation" style="color:rgb(153, 76, 195)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>907 records were matched with this query, resulting in 2,358 total GERS associations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p><strong>Geospatial matching is a pain</strong>. However, by matching against Overture data once through a polished script or pipeline, you can seamlessly join with any other Global Entity Reference System (GERS) associated datasets. This integration makes your data more accessible, accelerates onboarding processes, and expands usability across teams that have also matched against GERS.</p>
<p>By leveraging GERS associations, teams can share the results of complex matching efforts and significantly enhance data value through simplified connections to additional datasets.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"></div><div class="col lastUpdated_JAkA"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2025-05-22T13:35:36.000Z" itemprop="dateModified">May 22, 2025</time></b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/gers/gers-demonstrations/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">GERS Demonstrations</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/attribution/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Attribution and Licensing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-associate-your-data-with-gers-identifiers" class="table-of-contents__link toc-highlight">Why associate your data with GERS identifiers?</a></li><li><a href="#process-overview" class="table-of-contents__link toc-highlight">Process overview</a></li><li><a href="#performing-an-initial-match" class="table-of-contents__link toc-highlight">Performing an initial match</a><ul><li><a href="#planning-our-match" class="table-of-contents__link toc-highlight">Planning our match</a></li><li><a href="#staging-our-datasets" class="table-of-contents__link toc-highlight">Staging our datasets</a></li><li><a href="#matching-our-data" class="table-of-contents__link toc-highlight">Matching our data</a></li></ul></li><li><a href="#enriching-data-with-gers-ids--producing-a-bridge-file" class="table-of-contents__link toc-highlight">Enriching data with GERS IDs &amp; producing a bridge file</a><ul><li><a href="#enriching-our-table" class="table-of-contents__link toc-highlight">Enriching our table</a></li><li><a href="#producing-a-bridge-file" class="table-of-contents__link toc-highlight">Producing a bridge file</a></li></ul></li><li><a href="#performing-a-maintenance-match" class="table-of-contents__link toc-highlight">Performing a maintenance match</a><ul><li><a href="#associating-with-every-monthly-release" class="table-of-contents__link toc-highlight">Associating with every monthly release</a></li><li><a href="#overture-data-changelog" class="table-of-contents__link toc-highlight">Overture data changelog</a></li><li><a href="#finding-a-subset-of-records-that-need-matching" class="table-of-contents__link toc-highlight">Finding a subset of records that need matching</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Overture Maps Foundation.</div></div></div></footer></div>
</body>
</html>